function w(l){return l?.length!==void 0?l:Array.from(l)}class I{owner;microsecondsPerBeat;trackInfo;finished;currentTick;channels;currentEvents;constructor(i){this.owner=i,this.trackInfo=i.tracks.map(()=>({currentName:"",currentPosition:0,currentTick:0,finished:!1})),this.microsecondsPerBeat=6e7/120,this.finished=!1,this.currentTick=0,this.channels=[];for(let s=0;s<16;s++)this.channels.push({currentInstrument:0,instrumentName:"",pressedKeys:new Set});this.currentEvents=[]}next(...i){if(this.finished)return{done:!0,value:void 0};for(let e=0;e<this.currentEvents.length;e++)this.postProcessEvent(this.currentEvents[e]);let s=[],n=1/0,r=[];for(let e=0;e<this.owner.tracks.length;e++){if(this.trackInfo[e].finished)continue;let o=this.owner.tracks[e].event,c=this.trackInfo[e].currentPosition,t=this.trackInfo[e].currentTick,d=!1;for(;t+o[c].deltaTime<this.currentTick;)t+=o[c].deltaTime,c++,c>=o.length&&(d=!0);if(this.trackInfo[e].currentPosition=c,this.trackInfo[e].currentTick=t,this.trackInfo[e].finished=d,!d){let a=o[c].deltaTime+t;if(t+=o[c].deltaTime,n==null||a-this.currentTick<=n){for(a-this.currentTick<n&&(s=[],r=[]),n=a-this.currentTick,s.push({track:e,position:c,event:o[c]}),c++,c>=o.length&&(d=!0);!d&&o[c].deltaTime==0;)s.push({track:e,position:c,event:o[c++]}),c>=o.length&&(d=!0);r.push({track:e,event:c,currentTick:t,finished:d})}}}if(r.length==0)return this.finished=!0,{done:!0,value:void 0};this.currentTick=this.currentTick+n;for(let e=0;e<r.length;e++)this.trackInfo[r[e].track].currentPosition=r[e].event,this.trackInfo[r[e].track].currentTick=r[e].currentTick,this.trackInfo[r[e].track].finished=r[e].finished;for(let e=0;e<s.length;e++)this.processEvent(s[e]);return{done:!1,value:{after:n,events:s}}}processEvent(i){i.event.type==255&&(i.event.metaType==3&&(this.trackInfo[i.track].currentName=i.event.data),i.event.metaType==81&&(this.microsecondsPerBeat=i.event.data)),i.event.type==12&&(this.channels[i.event.channel].currentInstrument=i.event.data),i.event.type==9}postProcessEvent(i){}getChannelState(i){return this.channels[i]}return(i){return this.finished=!0,{done:!0,value:i}}throw(i){return this.finished=!0,{done:!0,value:void 0}}[Symbol.iterator](){return this}}class k{owner;tracks;constructor(i,s){this.owner=i,this.tracks=s}play(){return new I(this)}structure(){if(this.tracks.length==this.owner.data.track.length)return this.owner.data;let i=this.owner.data.track;this.owner.data.track=[];let s=JSON.parse(JSON.stringify(this.owner.data));return this.owner.data.track=i,s.track=this.tracks,s.tracks=this.tracks.length,s}}class y{data;constructor(i){this.data=i}getAvailableMusics(){switch(this.data.formatType){case 0:return[new k(this,[this.data.track[0]])];case 1:return[new k(this,this.data.track)];case 2:return this.data.track.map(i=>new k(this,[i]));default:return[]}}isolateTrack(i){return new k(this,[this.data.track[i]])}selectTracksAsMusic(i){return new k(this,this.data.track.filter((s,n)=>i.includes(n)))}allTracksAsMusic(){return new k(this,this.data.track)}}var T=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function m(l){return l&&l.__esModule&&Object.prototype.hasOwnProperty.call(l,"default")?l.default:l}function x(l){if(l.__esModule)return l;var i=l.default;if(typeof i=="function"){var s=function n(){return this instanceof n?Reflect.construct(i,arguments,this.constructor):i.apply(this,arguments)};s.prototype=i.prototype}else s={};return Object.defineProperty(s,"__esModule",{value:!0}),Object.keys(l).forEach(function(n){var r=Object.getOwnPropertyDescriptor(l,n);Object.defineProperty(s,n,r.get?r:{enumerable:!0,get:function(){return l[n]}})}),s}var v={exports:{}};(function(l){(function(){const i=function(n){let r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/;if(n=n.replace(/^.*?base64,/,""),n=String(n).replace(/[\t\n\f\r ]+/g,""),!e.test(n))throw new TypeError("Failed to execute _atob() : The string to be decoded is not correctly encoded.");n+="==".slice(2-(n.length&3));let o,c="",t,d,a=0;for(;a<n.length;)o=r.indexOf(n.charAt(a++))<<18|r.indexOf(n.charAt(a++))<<12|(t=r.indexOf(n.charAt(a++)))<<6|(d=r.indexOf(n.charAt(a++))),c+=t===64?String.fromCharCode(o>>16&255):d===64?String.fromCharCode(o>>16&255,o>>8&255):String.fromCharCode(o>>16&255,o>>8&255,o&255);return c},s={debug:!1,parse:function(n,r){if(n instanceof Uint8Array)return s.Uint8(n);if(typeof n=="string")return s.Base64(n);if(n instanceof HTMLElement&&n.type==="file")return s.addListener(n,r);throw new Error("MidiParser.parse() : Invalid input provided")},addListener:function(n,r){if(!File||!FileReader)throw new Error("The File|FileReader APIs are not supported in this browser. Use instead MidiParser.Base64() or MidiParser.Uint8()");if(n===void 0||!(n instanceof HTMLElement)||n.tagName!=="INPUT"||n.type.toLowerCase()!=="file")return console.warn("MidiParser.addListener() : Provided element is not a valid FILE INPUT element"),!1;r=r||function(){},n.addEventListener("change",function(e){if(!e.target.files.length)return!1;console.log("MidiParser.addListener() : File detected in INPUT ELEMENT processing data..");let o=new FileReader;o.readAsArrayBuffer(e.target.files[0]),o.onload=function(c){r(s.Uint8(new Uint8Array(c.target.result)))}})},Base64:function(n){n=String(n);let r=i(n),e=r.length,o=new Uint8Array(new ArrayBuffer(e));for(let c=0;c<e;c++)o[c]=r.charCodeAt(c);return s.Uint8(o)},Uint8:function(n){let r={data:null,pointer:0,movePointer:function(t){return this.pointer+=t,this.pointer},readInt:function(t){if(t=Math.min(t,this.data.byteLength-this.pointer),t<1)return-1;let d=0;if(t>1)for(let a=1;a<=t-1;a++)d+=this.data.getUint8(this.pointer)*Math.pow(256,t-a),this.pointer++;return d+=this.data.getUint8(this.pointer),this.pointer++,d},readStr:function(t){let d="";for(let a=1;a<=t;a++)d+=String.fromCharCode(this.readInt(1));return d},readIntVLV:function(){let t=0;if(this.pointer>=this.data.byteLength)return-1;if(this.data.getUint8(this.pointer)<128)t=this.readInt(1);else{let d=[];for(;this.data.getUint8(this.pointer)>=128;)d.push(this.readInt(1)-128);let a=this.readInt(1);for(let h=1;h<=d.length;h++)t+=d[d.length-h]*Math.pow(128,h);t+=a}return t}};if(r.data=new DataView(n.buffer,n.byteOffset,n.byteLength),r.readInt(4)!==1297377380)return console.warn("Header validation failed (not MIDI standard or file corrupt.)"),!1;r.readInt(4);let e={};e.formatType=r.readInt(2),e.tracks=r.readInt(2),e.track=[];let o=r.readInt(1),c=r.readInt(1);o>=128?(e.timeDivision=[],e.timeDivision[0]=o-128,e.timeDivision[1]=c):e.timeDivision=o*256+c;for(let t=1;t<=e.tracks;t++){e.track[t-1]={event:[]};let d=r.readInt(4);if(d===-1)break;if(d!==1297379947)return!1;r.readInt(4);let a=0,h=!1,u,p;for(;!h&&(a++,e.track[t-1].event[a-1]={},e.track[t-1].event[a-1].deltaTime=r.readIntVLV(),u=r.readInt(1),u!==-1);)if(u>=128?p=u:(u=p,r.movePointer(-1)),u===255){e.track[t-1].event[a-1].type=255,e.track[t-1].event[a-1].metaType=r.readInt(1);let f=r.readIntVLV();switch(e.track[t-1].event[a-1].metaType){case 47:case-1:h=!0;break;case 1:case 2:case 3:case 4:case 5:case 7:case 6:e.track[t-1].event[a-1].data=r.readStr(f);break;case 33:case 89:case 81:e.track[t-1].event[a-1].data=r.readInt(f);break;case 84:e.track[t-1].event[a-1].data=[],e.track[t-1].event[a-1].data[0]=r.readInt(1),e.track[t-1].event[a-1].data[1]=r.readInt(1),e.track[t-1].event[a-1].data[2]=r.readInt(1),e.track[t-1].event[a-1].data[3]=r.readInt(1),e.track[t-1].event[a-1].data[4]=r.readInt(1);break;case 88:e.track[t-1].event[a-1].data=[],e.track[t-1].event[a-1].data[0]=r.readInt(1),e.track[t-1].event[a-1].data[1]=r.readInt(1),e.track[t-1].event[a-1].data[2]=r.readInt(1),e.track[t-1].event[a-1].data[3]=r.readInt(1);break;default:this.customInterpreter!==null&&(e.track[t-1].event[a-1].data=this.customInterpreter(e.track[t-1].event[a-1].metaType,r,f)),(this.customInterpreter===null||e.track[t-1].event[a-1].data===!1)&&(r.readInt(f),e.track[t-1].event[a-1].data=r.readInt(f),this.debug&&console.info("Unimplemented 0xFF meta event! data block readed as Integer"))}}else switch(u=u.toString(16).split(""),u[1]||u.unshift("0"),e.track[t-1].event[a-1].type=parseInt(u[0],16),e.track[t-1].event[a-1].channel=parseInt(u[1],16),e.track[t-1].event[a-1].type){case 15:{if(this.customInterpreter!==null&&(e.track[t-1].event[a-1].data=this.customInterpreter(e.track[t-1].event[a-1].type,r,!1)),this.customInterpreter===null||e.track[t-1].event[a-1].data===!1){let f=r.readIntVLV();e.track[t-1].event[a-1].data=r.readInt(f),this.debug&&console.info("Unimplemented 0xF exclusive events! data block readed as Integer")}break}case 10:case 11:case 14:case 8:case 9:e.track[t-1].event[a-1].data=[],e.track[t-1].event[a-1].data[0]=r.readInt(1),e.track[t-1].event[a-1].data[1]=r.readInt(1);break;case 12:case 13:e.track[t-1].event[a-1].data=r.readInt(1);break;case-1:h=!0;break;default:if(this.customInterpreter!==null&&(e.track[t-1].event[a-1].data=this.customInterpreter(e.track[t-1].event[a-1].metaType,r,!1)),this.customInterpreter===null||e.track[t-1].event[a-1].data===!1)return console.log("Unknown EVENT detected... reading cancelled!"),!1}}return e},customInterpreter:null};l.exports=s})()})(v);var g=v.exports;const b=m(g);export{y as M,x as a,T as c,w as e,m as g,b as p};

import{M as v}from"./main.gADFQzQ8.js";import{g as k}from"./physics.j8OraWG_.js";function b(y,p){debugger;let s=new v(y).allTracksAsMusic().play(),e=null,o=[],r=[];for(let n=0;n<16;n++)r.push({});let c=0;for(p(null,"preamble");!(e=s.next()).done;){let n=s.owner.owner.data.timeDivision,u=s.microsecondsPerBeat,h=e.value.after/n*u/1e3;c+=h;for(let a=0;a<e.value.events.length;a++){let i=e.value.events[a],t=i.event;if(t.type==9&&t.data[1]===0&&(t={...t,type:8}),(t.type==8||t.type==9)&&r[t.channel][t.data[0]]!=null){let g=r[t.channel][t.data[0]];o.push({at:g,duration:c-g,note:t.data[0],instrument:i.track,instrumentName:s.trackInfo[i.track].currentName}),delete r[t.channel][t.data[0]]}t.type==9&&(r[t.channel][t.data[0]]=c)}}return o.sort((n,u)=>n.at-u.at),w(o,p)}function w(y,p){let d=new Map;t:for(let s=0;s<y.length;s++){p(s/y.length,"Main track generation");let e=y[s],o=d.get(e.instrument)??[];d.set(e.instrument,o);let r=99999999,c=-1;for(let l=0;l<o.length;l++){let m=o[l],h=m.sections[m.sections.length-1],a=m.finalSnapshot,i=k(a,(e.at-h.activate)/1e3);if(!(i.my<40&&i.my>-40)&&!(Math.abs(a.y-i.y)<13&&Math.sign(a.my)==Math.sign(i.my))&&r>h.activate){r=h.activate,c=l;break}}if(c>=0){let l=o[c],m=l.sections[l.sections.length-1],h=l.finalSnapshot,a=k(h,(e.at-m.activate)/1e3),i=a.my>0;l.sections.push({activate:e.at,snapshot:a,bar:{x:a.x-10,width:20,y:(i?5:-6)+a.y,height:1,duration:e.duration,color:e.note}});let t={...a};t.my*=-.9,l.finalSnapshot=t;continue t}let n={x:e.at/10,mx:50,my:100,y:0},u={...n};u.my*=-.9;let f={sections:[{activate:e.at,snapshot:n,bar:{x:n.x-10,width:20,y:5+n.y,height:1,duration:e.duration,color:e.note}}],finalSnapshot:u,instrument:e.instrument,instrumentName:e.instrumentName};o.push(f)}return Array.from(d.values()).flat(1)}export{b as default};

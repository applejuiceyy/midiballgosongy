class g{owner;microsecondsPerBeat;trackInfo;finished;currentTick;channels;currentEvents;constructor(t){this.owner=t,this.trackInfo=t.tracks.map(()=>({currentName:"",currentPosition:0,currentTick:0,finished:!1})),this.microsecondsPerBeat=6e7/120,this.finished=!1,this.currentTick=0,this.channels=[];for(let r=0;r<16;r++)this.channels.push({currentInstrument:0,instrumentName:"",pressedKeys:new Set});this.currentEvents=[]}next(...t){if(this.finished)return{done:!0,value:void 0};for(let e=0;e<this.currentEvents.length;e++)this.postProcessEvent(this.currentEvents[e]);let r=[],l=1/0,n=[];for(let e=0;e<this.owner.tracks.length;e++){if(this.trackInfo[e].finished)continue;let s=this.owner.tracks[e].event,i=this.trackInfo[e].currentPosition,o=this.trackInfo[e].currentTick,h=!1;for(;o+s[i].deltaTime<this.currentTick;)o+=s[i].deltaTime,i++,i>=s.length&&(h=!0);if(this.trackInfo[e].currentPosition=i,this.trackInfo[e].currentTick=o,this.trackInfo[e].finished=h,!h){let m=s[i].deltaTime+o;if(o+=s[i].deltaTime,l==null||m-this.currentTick<=l){for(m-this.currentTick<l&&(r=[],n=[]),l=m-this.currentTick,r.push({track:e,position:i,event:s[i]}),i++,i>=s.length&&(h=!0);!h&&s[i].deltaTime==0;)r.push({track:e,position:i,event:s[i++]}),i>=s.length&&(h=!0);n.push({track:e,event:i,currentTick:o,finished:h})}}}if(n.length==0)return this.finished=!0,{done:!0,value:void 0};this.currentTick=this.currentTick+l;for(let e=0;e<n.length;e++)this.trackInfo[n[e].track].currentPosition=n[e].event,this.trackInfo[n[e].track].currentTick=n[e].currentTick,this.trackInfo[n[e].track].finished=n[e].finished;for(let e=0;e<r.length;e++)this.processEvent(r[e]);return{done:!1,value:{after:l,events:r}}}processEvent(t){t.event.type==255&&(t.event.metaType==3&&(this.trackInfo[t.track].currentName=t.event.data),t.event.metaType==81&&(this.microsecondsPerBeat=t.event.data)),t.event.type==12&&(this.channels[t.event.channel].currentInstrument=t.event.data),t.event.type==9}postProcessEvent(t){}getChannelState(t){return this.channels[t]}return(t){return this.finished=!0,{done:!0,value:t}}throw(t){return this.finished=!0,{done:!0,value:void 0}}[Symbol.iterator](){return this}}class v{owner;tracks;constructor(t,r){this.owner=t,this.tracks=r}play(){return new g(this)}structure(){if(this.tracks.length==this.owner.data.track.length)return this.owner.data;let t=this.owner.data.track;this.owner.data.track=[];let r=JSON.parse(JSON.stringify(this.owner.data));return this.owner.data.track=t,r.track=this.tracks,r.tracks=this.tracks.length,r}}class T{data;constructor(t){this.data=t}getAvailableMusics(){switch(this.data.formatType){case 0:return[new v(this,[this.data.track[0]])];case 1:return[new v(this,this.data.track)];case 2:return this.data.track.map(t=>new v(this,[t]));default:return[]}}isolateTrack(t){return new v(this,[this.data.track[t]])}selectTracksAsMusic(t){return new v(this,this.data.track.filter((r,l)=>t.includes(l)))}allTracksAsMusic(){return new v(this,this.data.track)}}function p(a,t){if(t<0){a.mx*=-1,a.my*=-1;let r=p(a,-t);return a.mx*=-1,a.my*=-1,r.mx*=-1,r.my*=-1,r}return{x:a.mx*t+a.x,y:a.my*t+Math.pow(t,2)/2*350+a.y,mx:a.mx,my:a.my+t*350}}globalThis._e=p;function M(a,t){debugger;let l=new T(a).allTracksAsMusic().play(),n=null,e=[],s=[];for(let o=0;o<16;o++)s.push({});let i=0;for(t(null,"preamble");!(n=l.next()).done;){let o=l.owner.owner.data.timeDivision,h=l.microsecondsPerBeat,k=n.value.after/o*h/1e3;i+=k;for(let u=0;u<n.value.events.length;u++){let d=n.value.events[u],c=d.event;if(c.type==9&&c.data[1]===0&&(c={...c,type:8}),(c.type==8||c.type==9)&&s[c.channel][c.data[0]]!=null){let w=s[c.channel][c.data[0]];e.push({at:w,duration:i-w,note:c.data[0],instrument:d.track,instrumentName:l.trackInfo[d.track].currentName}),delete s[c.channel][c.data[0]]}c.type==9&&(s[c.channel][c.data[0]]=i)}}return e.sort((o,h)=>o.at-h.at),I(e,t)}function I(a,t){let r=new Map;t:for(let l=0;l<a.length;l++){t(l/a.length,"Main track generation");let n=a[l],e=r.get(n.instrument)??[];r.set(n.instrument,e);let s=99999999,i=-1;for(let f=0;f<e.length;f++){let y=e[f],k=y.sections[y.sections.length-1],u=y.finalSnapshot,d=p(u,(n.at-k.activate)/1e3);if(!(d.my<40&&d.my>-40)&&!(Math.abs(u.y-d.y)<13&&Math.sign(u.my)==Math.sign(d.my))&&s>k.activate){s=k.activate,i=f;break}}if(i>=0){let f=e[i],y=f.sections[f.sections.length-1],k=f.finalSnapshot,u=p(k,(n.at-y.activate)/1e3),d=u.my>0;f.sections.push({activate:n.at,snapshot:u,bar:{x:u.x-10,width:20,y:(d?5:-6)+u.y,height:1,duration:n.duration,color:n.note}});let c={...u};c.my*=-.9,f.finalSnapshot=c;continue t}let o={x:n.at/10,mx:50,my:100,y:0},h={...o};h.my*=-.9;let m={sections:[{activate:n.at,snapshot:o,bar:{x:o.x-10,width:20,y:5+o.y,height:1,duration:n.duration,color:n.note}}],finalSnapshot:h,instrument:n.instrument,instrumentName:n.instrumentName};e.push(m)}return Array.from(r.values()).flat(1)}export{M as default};
